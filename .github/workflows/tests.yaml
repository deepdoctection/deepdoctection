name: Tests

on:
  push:
    branches:
      - "*"
  pull_request:
    branches: [ master ]

permissions:
  contents: read

jobs:
  core-and-datasets-tests:
    if: "contains(github.event.head_commit.message, '[force ci]') || github.ref == 'refs/heads/master' || github.event_name == 'pull_request'"
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: true
      matrix:
        include:
          # py{310,312}-core-test
          - { name: 'py310-core-test', python: '3.10', pip: '25.3', tox: '4.32.0', os: 'ubuntu-latest', poppler: false, tesseract: false }
          - { name: 'py312-core-test', python: '3.12', pip: '25.3', tox: '4.32.0', os: 'ubuntu-latest', poppler: false, tesseract: false }

          # py{310,312}-core-full
          - { name: 'py310-core-full', python: '3.10', pip: '25.3', tox: '4.32.0', os: 'ubuntu-latest', poppler: false, tesseract: false }
          - { name: 'py312-core-full', python: '3.12', pip: '25.3', tox: '4.32.0', os: 'ubuntu-latest', poppler: false, tesseract: false }

          # py{310,312}-datasets-test
          - { name: 'py310-datasets-test', python: '3.10', pip: '25.3', tox: '4.32.0', os: 'ubuntu-latest', poppler: false, tesseract: false }
          - { name: 'py312-datasets-test', python: '3.12', pip: '25.3', tox: '4.32.0', os: 'ubuntu-latest', poppler: false, tesseract: false }

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Install tooling (pip, tox)
        run: |
          python -m pip install --upgrade pip==${{ matrix.pip }}
          python -m pip install tox==${{ matrix.tox }}
          tox --version

      - name: Install Poppler (if needed)
        if: matrix.poppler
        run: |
          sudo apt-get update
          sudo apt-get install -y poppler-utils

      - name: Install Tesseract (if needed)
        if: matrix.tesseract
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr tesseract-ocr-deu

      - name: Run tox via make
        env:
          TOX_ENV: ${{ matrix.name }}
        run: make test

  deepdoctection-tests:
    if: "contains(github.event.head_commit.message, '[force ci]') || github.ref == 'refs/heads/master' || github.event_name == 'pull_request'"
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: true
      matrix:
        include:
          # py{310,312}-deepdoctection-test
          - { name: 'py310-deepdoctection-test', python: '3.10', pip: '25.3', tox: '4.32.0', os: 'ubuntu-latest', poppler: false, tesseract: false }
          - { name: 'py312-deepdoctection-test', python: '3.12', pip: '25.3', tox: '4.32.0', os: 'ubuntu-latest', poppler: false, tesseract: false }

          # py{310,312}-deepdoctection-full
          - { name: 'py310-deepdoctection-full', python: '3.10', pip: '25.3', tox: '4.32.0', os: 'ubuntu-latest', poppler: false, tesseract: false }
          - { name: 'py312-deepdoctection-full', python: '3.12', pip: '25.3', tox: '4.32.0', os: 'ubuntu-latest', poppler: false, tesseract: false }

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Install tooling (pip, tox)
        run: |
          python -m pip install --upgrade pip==${{ matrix.pip }}
          python -m pip install tox==${{ matrix.tox }}
          tox --version

      - name: Install Poppler (if needed)
        if: matrix.poppler
        run: |
          sudo apt-get update
          sudo apt-get install -y poppler-utils

      - name: Install Tesseract (if needed)
        if: matrix.tesseract
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr tesseract-ocr-deu

      - name: Run tox via make
        env:
          TOX_ENV: ${{ matrix.name }}
        run: make test

  all-and-slow-tests:
    if: "contains(github.event.head_commit.message, '[force ci]') || github.ref == 'refs/heads/master' || github.event_name == 'pull_request'"
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: true
      matrix:
        include:
          # py{310,312}-all-test-full (needs poppler + tesseract)
          - { name: 'py310-all-test-full', python: '3.10', pip: '25.3', tox: '4.32.0', os: 'ubuntu-latest', poppler: true,  tesseract: true }
          - { name: 'py312-all-test-full', python: '3.12', pip: '25.3', tox: '4.32.0', os: 'ubuntu-latest', poppler: true,  tesseract: true }

          # py{310,312}-deepdoctection-slow (tesseract only)
          - { name: 'py310-deepdoctection-slow', python: '3.10', pip: '25.3', tox: '4.32.0', os: 'ubuntu-latest', poppler: false, tesseract: true }
          - { name: 'py312-deepdoctection-slow', python: '3.12', pip: '25.3', tox: '4.32.0', os: 'ubuntu-latest', poppler: false, tesseract: true }

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Install tooling (pip, tox)
        run: |
          python -m pip install --upgrade pip==${{ matrix.pip }}
          python -m pip install tox==${{ matrix.tox }}
          tox --version

      - name: Install Poppler (if needed)
        if: matrix.poppler
        run: |
          sudo apt-get update
          sudo apt-get install -y poppler-utils

      - name: Install Tesseract (if needed)
        if: matrix.tesseract
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr tesseract-ocr-deu

      - name: Run tox via make
        env:
          TOX_ENV: ${{ matrix.name }}
        run: make test
