name: build_push_pypi

on:
  release:
    types: [published]

jobs:
  build_and_upload:
    name: build_push_pypi_package
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      - name: Install dependencies
        run: pip install setuptools wheel twine

      - name: Verify version matches
        run: |
          # Get tag version (without the 'v' prefix)
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          # Get package version
          PACKAGE_VERSION=$(python -c "import deepdoctection; print(deepdoctection.__version__)")
          echo "Tag version: $TAG_VERSION"
          echo "Package version: $PACKAGE_VERSION"
          
          # Check if versions match
          if [ "$TAG_VERSION" != "$PACKAGE_VERSION" ]; then
            echo "Error: Version mismatch!"
            echo "Tag version ($TAG_VERSION) doesn't match package version ($PACKAGE_VERSION)"
            exit 1
          fi
          echo "Version check passed: $PACKAGE_VERSION"

      - name: Build package
        run: make package

      - name: Upload to PyPI
        env:
          PYPI_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        run: twine upload dist/* -u __token__ -p $PYPI_TOKEN
